library(readxl)
library(dplyr)
library(readr)
library(purrr)
library(curl)

#### Vector with all IBGE codes for RN ----

rn_geo_ids <-
  c(
    2400505,
    2400802,
    2401305,
    2401651,
    2401800,
    2402105,
    2402907,
    2403400,
    2403707,
    2404002,
    2404408,
    2404903,
    2405702,
    2406155,
    2406700,
    2407203,
    2407708,
    2414753,
    2400208,
    2400406,
    2400703,
    2400901,
    2401107,
    2401206,
    2401453,
    2401503,
    2401859,
    2401909,
    2402006,
    2402204,
    2402303,
    2402709,
    2402808,
    2404606,
    2403202,
    2403509,
    2403608,
    2403756,
    2403806,
    2404101,
    2404200,
    2404309,
    2404705,
    2404853,
    2405009,
    2405108,
    2405405,
    2405801,
    2405900,
    2406007,
    2406601,
    2406809,
    2406908,
    2407302,
    2407500,
    2407609,
    2407807,
    2408102,
    2408300,
    2408409,
    2408607,
    2408953,
    2409308,
    2409332,
    2411106,
    2409506,
    2409803,
    2410009,
    2410256,
    2410603,
    2410702,
    2411007,
    2411056,
    2411429,
    2411601,
    2411809,
    2411908,
    2412203,
    2412401,
    2412500,
    2412807,
    2413201,
    2413300,
    2413359,
    2413557,
    2413805,
    2413904,
    2414100,
    2414209,
    2414456,
    2414506,
    2414902,
    2415008,
    2403103,
    2406106,
    2413102,
    2408805,
    2410108,
    2410306,
    2400109,
    2400307,
    2402402,
    2403301,
    2404804,
    2405603,
    2408201,
    2409407,
    2410900,
    2411502,
    2413003,
    2413607,
    2414704,
    2410801,
    2411403,
    2411700,
    2412302,
    2412559,
    2412906,
    2401701,
    2407104,
    2414001,
    2414308,
    2414407,
    2405504,
    2412708,
    2413706,
    2400604,
    2401008,
    2401404,
    2401602,
    2403004,
    2402501,
    2402600,
    2403251,
    2403905,
    2406304,
    2404507,
    2405207,
    2405306,
    2406205,
    2406502,
    2407005,
    2407401,
    2407906,
    2408003,
    2408508,
    2408706,
    2408904,
    2409100,
    2409209,
    2409605,
    2409704,
    2409902,
    2410207,
    2410405,
    2410504,
    2411205,
    2412005,
    2412104,
    2412609,
    2413409,
    2413508,
    2414159,
    2414605,
    2414803,
    2406403,
    2407252
  )

### Function to get all data ----

get_state_table <- function(city_id, disease = "dengue") {
  url <-
    paste0(
      "https://info.dengue.mat.br/api/alertcity?geocode=",
      city_id,
      "&disease=",
      disease,
      "&format=csv&ew_start=1&ew_end=53&ey_start=2022&ey_end=2022"
    )

  read_csv(curl(url)) %>%
    mutate(city_code = city_id) %>%
    select(SE, casos_est, pop, city_code)
}

rn_epi_data <-
  map_dfr(rn_geo_ids,
          ~ get_state_table(city_id = .x))

info_rgis <- read_xls("data/regioes_geograficas_composicao_por_municipios_2017_20180911.xls")

rn_by_rgi <- rn_epi_data %>%
  mutate(city_code = as.character(city_code)) %>%
  left_join(info_rgis, by = c("city_code" = "CD_GEOCODI"))

saveRDS(rn_by_rgi, file = "data/dengue_all_rn_cities.rds")


